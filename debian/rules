#!/usr/bin/make -f

# It would be nice to build ghcjs inside our current directory, but
# the path gets recorded in the result.  So TOP needs to be "/".
# TOP := $(PWD)
TOP := /

BRANCH := ghc-8.4
NAME := ghcjs
HOMEREL := usr/lib/$(NAME)
# This was HOME, but that meant all the cabal packages got installed
# in /usr/lib/ghcjs, and were then wiped out on each run.  But I
# seem to recall that the ghcjs build requires HOME to be set, so we
# will see.
HOMEABS := $(TOP)$(HOMEREL)
DEB_DH_SHLIBDEPS_ARGS += -X$(HOMEREL)/.ghcjs -XlibHS

# Avoid capturing the home directory in all the Paths_*.hs files.
HOME := $(HOMEABS)

include /usr/share/cdbs/1/rules/debhelper.mk
# include /usr/share/cdbs/1/class/hlibrary.mk

build/$(NAME):: debian/$(NAME)-build-stamp

# The result of this build is in /usr/lib/ghcjs.
debian/$(NAME)-build-stamp:
	# Uninstall any existing ghcjs deb
	-apt-get remove $(NAME) --yes --force-yes
	# Get rid of any existing clone of ghcjs
	-rm -rf $(HOMEABS)
	# Clone the ghcjs repository
	git clone https://github.com/ghcjs/ghcjs -b $(BRANCH) $(HOMEABS)
	# Apply our local patches
	cat ghcjs.diff | { cd $(HOMEABS) && patch -p1; }
	# cabal install ghcjs/lib/ghcjs-prim
	# test "$(GHCVER)" = "8.2.2" && { ghc-pkg latest haddock-api || { cd haddock-api-2.17.3 && cabal install; }; } || true
	# test "$(GHCVER)" = "8.2.2" && { ghc-pkg latest shelly || { cd shelly-1.6.8.4 && cabal install; }; } || true
	# Install customized ghcjs dependency packages
	cd $(HOMEABS) && HOME=$(HOMEABS) && utils/makePackages.sh link
	# cd $(NAME) && cabal install --avoid-reinstalls --global --only-dependencies
	HOME=$(HOMEABS) && cabal update
	cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-configure
	cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-build
	cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-install --symlink-bindir=/usr/bin
	# Set up some haddock support
	# mkdir -p /usr/lib/ghcjs/.cabal/share/x86_64-linux-ghc-8.4.3/haddock-api-ghcjs-2.20.0
	D=`echo ./dist-newstyle/build/*/*/haddock-api-ghcjs-* | sed -n 's:^.*/\(.*\)/\(.*\)/\(.*\):/usr/lib/ghcjs/.cabal/share/\1-\2/\3:p'` && mkdir -p $D && rsync -aHxS --delete /usr/lib/ghc/html/ $D/html
	# Now ghcjs exists and should be in the path, we can ask its version
	ghcjs-boot --with-node /usr/bin/nodejs -s lib/boot
        # --shims-dev-branch "-B ghc-8.2 c275ffca803150efb90a4f97402a9c865e73929a"
	touch $@

install/$(NAME):: debian/$(NAME)-binary-stamp

debian/$(NAME)-binary-stamp:
	# Libraries that Provides.hs script needs to run
	cabal install regex-tdfa
	# Build debian/ghcjs.install and debian/ghcjs.substvars
	runhaskell -idebian debian/Provides.hs $(TOP) $(HOMEREL)
	touch $@

clean::
	rm -rf $(TOP)$(HOMEREL) usr ghcjs-[78]* debian/$(NAME)-build-stamp debian/$(NAME)-binary-stamp debian/$(NAME).install debian/$(NAME).links debian/$(NAME).substvars debian/$(NAME).triggers haddock-api-2.17.3/dist shelly-1.6.8.1/dist
