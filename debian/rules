#!/usr/bin/make -f

# It would be nice to build ghcjs inside our current directory, but
# the path gets recorded in the result.  So TOP needs to be "/".
# TOP := $(PWD)
TOP := /

# This should be one of HVR's compiler versions, 8 or newer.
GHCVER := 8.0.1
BRANCH := ghc-8.0
NAME := ghcjs
HOMEREL := usr/lib/$(NAME)
# This was HOME, but that meant all the cabal packages got installed
# in /usr/lib/ghcjs, and were then wiped out on each run.  But I
# seem to recall that the ghcjs build requires HOME to be set, so we
# will see.
HOMEABS := $(TOP)$(HOMEREL)
PATH := $(HOMEABS)/.cabal/bin:$(PATH)
DEB_DH_SHLIBDEPS_ARGS += -X$(HOMEREL)/.ghcjs -XlibHS

# HOME := $(HOMEABS)

include /usr/share/cdbs/1/rules/debhelper.mk
# include /usr/share/cdbs/1/class/hlibrary.mk

build/$(NAME):: debian/$(NAME)-build-stamp

# The result of this build is in /usr/lib/ghcjs.
debian/$(NAME)-build-stamp:
	mkdir -p $(HOMEABS)
	mkdir -p /usr/share/haddock-api  # Prevent error "Haddock's resource directory (/usr/share/haddock-api) does not exist!"
	rsync -aHxS --delete /usr/lib/ghc/html/ /usr/share/haddock-api/html
	-apt-get remove $(NAME) --yes --force-yes
	PATH=$(PATH) cabal update
	-rm -r $(NAME)
	git clone https://github.com/ghcjs/ghcjs -b $(BRANCH) $(NAME)
	# cd ghcjs && patch -p1 < ../ghcjs.diff
	# cabal install ghcjs/lib/ghcjs-prim
	PATH=$(PATH) && test "$(GHCVER)" = "8.0.2" && { ghc-pkg latest haddock-api || { cd haddock-api-2.17.3 && cabal install; }; } || true
	PATH=$(PATH) && test "$(GHCVER)" = "8.0.2" && { ghc-pkg latest shelly || { cd shelly-1.6.8.1 && cabal install; }; } || true
	PATH=$(PATH) && cd $(NAME) && cabal install --avoid-reinstalls --global --only-dependencies
	PATH=$(PATH) && cd $(NAME) && cabal configure
	PATH=$(PATH) && cd $(NAME) && cabal build
	# Override $HOME to install into /usr/lib/ghcjs
	PATH=$(PATH) && HOME=$(HOMEABS) && cabal install ./$(NAME)
	# Now ghcjs exists and should be in the path, we can ask its version
	PATH=$(PATH) && ghcjs-boot --dev --with-node /usr/bin/nodejs --ghcjs-boot-dev-branch ghc-8.0 --shims-dev-branch ghc-8.0
	touch $@

install/$(NAME):: debian/$(NAME)-binary-stamp

debian/$(NAME)-binary-stamp:
	PATH=$(PATH) && cabal install ListLike regex-tdfa
	PATH=$(PATH) && runhaskell -idebian debian/Provides.hs $(TOP) $(HOMEREL) $(GHCVER)
	touch $@

clean::
	rm -rf $(TOP)$(HOMEREL) usr ghcjs-[78]* debian/$(NAME)-build-stamp debian/$(NAME)-binary-stamp debian/$(NAME).install debian/$(NAME).links debian/$(NAME).substvars debian/$(NAME).triggers haddock-api-2.17.3/dist shelly-1.6.8.1/dist
