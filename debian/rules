#!/usr/bin/make -f

# It would be nice to build ghcjs inside our current directory,
# but the path gets recorded in the result.  Try it.
# TOP := $(PWD)
TOP := /
HOMEREL := usr/lib/ghcjs
HOME := $(TOP)$(HOMEREL)
PATH := $(HOME)/.cabal/bin:$(PATH)
DEB_DH_SHLIBDEPS_ARGS += -X$(HOMEREL)/.ghcjs -XlibHS

include /usr/share/cdbs/1/rules/debhelper.mk
# include /usr/share/cdbs/1/class/hlibrary.mk

build/ghcjs:: debian/ghcjs-build-stamp

# The result of this build is in /usr/lib/ghcjs.
debian/ghcjs-build-stamp:
	mkdir -p $(HOME)
	cabal update
	rm -rf ghcjs && git clone https://github.com/ghcjs/ghcjs -b old-base-ghc-7.10 ghcjs
	cabal install ./ghcjs
	# Now ghcjs exists and should be in the path, we can ask its version
	ghcjs-boot --dev --with-node /usr/bin/nodejs --ghcjs-boot-dev-branch old-base-ghc-7.10
	# cd /usr/lib; rm -rf ghcjs; tar xfz /home/dsf/git/ghcjs-debian-1.tar.gz
	touch $@

install/ghcjs:: debian/ghcjs-binary-stamp

debian/ghcjs-binary-stamp:
	runhaskell -idebian debian/Provides.hs $(TOP) $(HOMEREL)
	touch $@

clean::
	rm -rf $(TOP)$(HOMEREL) usr ghcjs debian/ghcjs-build-stamp debian/ghcjs-binary-stamp debian/ghcjs.install debian/ghcjs.links debian/ghcjs.substvars debian/ghcjs.triggers
