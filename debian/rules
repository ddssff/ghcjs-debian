#!/usr/bin/make -f

# It would be nice to build ghcjs inside our current directory, but
# the path gets recorded in the result.  So TOP needs to be "/".
# TOP := $(PWD)
TOP := /

BRANCH := ghc-8.4
NAME := ghcjs
HOMEREL := usr/lib/$(NAME)
# This was HOME, but that meant all the cabal packages got installed
# in /usr/lib/ghcjs, and were then wiped out on each run.  But I
# seem to recall that the ghcjs build requires HOME to be set, so we
# will see.
HOMEABS := $(TOP)$(HOMEREL)
DEB_DH_SHLIBDEPS_ARGS += -X$(HOMEREL)/.ghcjs -XlibHS

export LD_LIBRARY_PATH=/usr/lib/ghcjs/ghc/libraries/array/dist-install/build:/usr/lib/ghcjs/ghc/libraries/base/dist-install/build:/usr/lib/ghcjs/ghc/libraries/binary/dist-install/build:/usr/lib/ghcjs/ghc/libraries/bytestring/dist-install/build:/usr/lib/ghcjs/ghc/libraries/containers/dist-install/build:/usr/lib/ghcjs/ghc/libraries/deepseq/dist-install/build:/usr/lib/ghcjs/ghc/libraries/directory/dist-install/build:/usr/lib/ghcjs/ghc/libraries/filepath/dist-install/build:/usr/lib/ghcjs/ghc/libraries/ghc-boot/dist-install/build:/usr/lib/ghcjs/ghc/libraries/ghc-boot-th/dist-install/build:/usr/lib/ghcjs/ghc/libraries/ghc-compact/dist-install/build:/usr/lib/ghcjs/ghc/libraries/ghci/dist-install/build:/usr/lib/ghcjs/ghc/libraries/ghc-prim/dist-install/build:/usr/lib/ghcjs/ghc/libraries/haskeline/dist-install/build:/usr/lib/ghcjs/ghc/libraries/hpc/dist-install/build:/usr/lib/ghcjs/ghc/libraries/integer-gmp/dist-install/build:/usr/lib/ghcjs/ghc/libraries/mtl/dist-install/build:/usr/lib/ghcjs/ghc/libraries/parsec/dist-install/build:/usr/lib/ghcjs/ghc/libraries/pretty/dist-install/build:/usr/lib/ghcjs/ghc/libraries/process/dist-install/build:/usr/lib/ghcjs/ghc/libraries/stm/dist-install/build:/usr/lib/ghcjs/ghc/libraries/template-haskell/dist-install/build:/usr/lib/ghcjs/ghc/libraries/terminfo/dist-install/build:/usr/lib/ghcjs/ghc/libraries/text/dist-install/build:/usr/lib/ghcjs/ghc/libraries/time/dist-install/build:/usr/lib/ghcjs/ghc/libraries/transformers/dist-install/build:/usr/lib/ghcjs/ghc/libraries/unix/dist-install/build:/usr/lib/ghcjs/ghc/rts/dist/build:/usr/lib/ghcjs/ghc/libraries/Cabal/Cabal/dist-install/build/:/usr/lib/ghcjs/ghc/compiler/stage2/build

# Avoid capturing the home directory in all the Paths_*.hs files.
# (Does this export make all the HOME= below unnecessary?)
export HOME := $(HOMEABS)

include /usr/share/cdbs/1/rules/debhelper.mk
# include /usr/share/cdbs/1/class/hlibrary.mk

build/$(NAME):: debian/$(NAME)-build-stamp

# The result of this build is in /usr/lib/ghcjs.
debian/$(NAME)-build-stamp:
	# Uninstall any existing ghcjs deb
	-apt-get remove $(NAME) --yes --force-yes
	# Get rid of any existing clone of ghcjs
	-rm -rf $(HOMEABS)
	# Clone the ghcjs repository
	git clone https://github.com/ghcjs/ghcjs -b $(BRANCH) $(HOMEABS)
	# Apply our local patches
	cat ghcjs.diff | { cd $(HOMEABS) && patch -p1; }
	cat ghcjs-bug-666.diff | { cd $(HOMEABS) && patch -p1; }
	cat DataDynamic.diff | { cd $(HOMEABS) && patch -p1; }
	# cabal install ghcjs/lib/ghcjs-prim
	cd $(HOMEABS) && HOME=$(HOMEABS) && utils/makePackages.sh link
	# cd $(NAME) && cabal install --avoid-reinstalls --global --only-dependencies
	HOME=$(HOMEABS) && cabal update
	cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-configure
	cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-build
	# cd $(HOMEABS) && HOME=$(HOMEABS) && cabal new-install --symlink-bindir=/usr/bin
	cd $(HOMEABS) && for i in ghcjs ghcjs-pkg ghcjs-run haddock-ghcjs hsc2hs-ghcjs ghcjs-boot; do ln -s ../lib/ghcjs/utils/dist-newstyle-wrapper.sh /usr/bin/$$i; done
	# Set up some haddock support
	cd $(HOMEABS) && D=`echo ./dist-newstyle/build/*/*/haddock-api-ghcjs-* | sed -n 's:^.*/\(.*\)/\(.*\)/\(.*\):/usr/lib/ghcjs/.cabal/share/\1-\2/\3:p'` && mkdir -p $$D && rsync -aHxS --delete /usr/lib/ghc/html/ $$D/html
	cd $(HOMEABS) && ghcjs-boot --with-node /usr/bin/nodejs -s lib/boot
	cd $(HOMEABS) && rm -rf ghc
	touch $@

install/$(NAME):: debian/$(NAME)-binary-stamp

debian/$(NAME)-binary-stamp:
	# Libraries that Provides.hs script needs to run
	HOME=$(HOMEABS) && cabal install regex-tdfa
	# Build debian/ghcjs.install and debian/ghcjs.substvars
	HOME=$(HOMEABS) && runhaskell -idebian debian/Provides.hs $(TOP) $(HOMEREL)
	touch $@

clean::
	rm -rf $(TOP)$(HOMEREL) usr ghcjs-[78]* debian/$(NAME)-build-stamp debian/$(NAME)-binary-stamp debian/$(NAME).install debian/$(NAME).links debian/$(NAME).substvars debian/$(NAME).triggers haddock-api-2.17.3/dist shelly-1.6.8.1/dist
